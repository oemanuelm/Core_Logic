/*
 * CORESENSE FIRMWARE - TESTE EXPERIMENTAL
 * Função: Ler DHT11/22 e controlar LED de Alerta via Serial
 */

#include <DHT.h>

// --- CONFIGURAÇÕES ---
#define DHTPIN 4       // Pino de dados do Sensor
#define DHTTYPE DHT22  
#define LED_BUILTIN 2      // LED Integrado do ESP32 

DHT dht(DHTPIN, DHTTYPE);

//Configuração inicial
void setup() {
  Serial.begin(115200); // Velocidade da Serial
  dht.begin();
  pinMode(LED_BUILTIN, OUTPUT);
  
  // Teste de LED na inicialização (Pisca 3x)
  for(int i=0; i<3; i++) {
    digitalWrite(LED_BUILTIN, HIGH); delay(100);
    digitalWrite(LED_BUILTIN, LOW);  delay(100);
  }
}

void loop() {
  // 1. LEITURA (Tratamento de erro incluso)
  float temperatura = dht.readTemperature();
  float umidade = dht.readHumidity();

  // Se o sensor falhar, envia 0.0 para não travar o Python
  if (isnan(temperatura)) temperatura = 0.0;
  if (isnan(umidade)) umidade = 0.0;

  // 2. ENVIA JSON PARA O PC
  // Formato: {"temp_amb": 25.0, "umidade": 60.0}
  Serial.print("{\"temp_amb\":");
  Serial.print(temperatura);
  Serial.print(",\"umidade\":");
  Serial.print(umidade);
  Serial.println("}"); // Pula linha para indicar fim da mensagem

  // 3. LER COMANDOS DO PC (Controle do LED)
  if (Serial.available() > 0) {
    char comando = Serial.read();
    
    if (comando == 'R') {
      digitalWrite(LED_BUILTIN, HIGH); // R = Risco (Liga LED)
    } 
    else if (comando == 'N') {
      digitalWrite(LED_BUILTIN, LOW);  // N = Normal (Desliga LED)
    }
  }

  delay(2000); // Espera 2 segundos (Ciclo do DHT)
}